/*
 * Copyright (c) 2019-present Sonatype, Inc.
 * This program and the accompanying materials are made available under
 * the terms of the Eclipse Public License 2.0 which accompanies this
 * distribution and is available at https://www.eclipse.org/legal/epl-2.0/.
 */
import React from 'react';
import classnames from 'classnames';
import { head, repeat, tail, toUpper } from 'ramda';

import { BaseCounterProps, MaxDigitCounterProps, CounterProps, Props, propTypes } from './types';
export { Props } from './types';

import './NxSmallVulnerabilityCounter.scss';
import NxTooltip from '../NxTooltip/NxTooltip';
import { VulnerabilitySeverityLevel } from '../../util/vulnerabilitySeverityLevels';

const SEVERITY_RANGE_MAP = Object.freeze({
  critical: '9.0\u201410.0',
  high: '7.0\u20148.9',
  medium: '4.0\u20146.9',
  low: '0.1\u20143.9',
  none: '0.0'
});

function BaseCounter({ category, count, display, children }: BaseCounterProps) {
  const categoryForDisplay = `${toUpper(head(category))}${tail(category)}`,
      className = classnames(`nx-small-vulnerability-counter nx-small-vulnerability-counter--${category}`, {
        'nx-small-vulnerability-counter--zero': count === 0
      });

  return (
    <NxTooltip title={`Vulnerability: ${categoryForDisplay} (${SEVERITY_RANGE_MAP[category]})`}>
      <div className={className}>
        {/* Ideally this would be implemented as an aria-label but that doesn't get read by ChromeVox */}
        <span className="nx-small-vulnerability-counter__category">{categoryForDisplay}</span>
        <span className="nx-small-vulnerability-counter__count">{display}</span>
        {children}
      </div>
    </NxTooltip>
  );
}

function Counter({ category, count }: CounterProps) {
  return <BaseCounter category={category} count={count} display={count} />;
}

function MaxDigitCounter({ category, count, maxDigits }: MaxDigitCounterProps) {
  // If we want maxDigits = 3 that means we want room for three digits in addition to a plus sign so
  // that we can show e.g. "999+"
  const overflowDisplay = repeat('9', maxDigits).concat('+').join(''),
      maxValue = Math.pow(10, Math.floor(maxDigits)) - 1;

  return (
    <BaseCounter category={category} count={count} display={count > maxValue ? overflowDisplay : count}>
      <div className="nx-small-vulnerability-counter__sizer">{overflowDisplay}</div>
    </BaseCounter>
  );
}

export default function NxSmallVulnerabilityCounter(props: Props) {
  const {
        criticalCount,
        highCount,
        mediumCount,
        lowCount,
        noneCount,
        maxDigits,
        className: classNameProp,
        ...attrs
      } = props,
      hasMaxDigits = maxDigits !== Infinity,
      className = classnames('nx-small-vulnerability-counter-container', classNameProp, {
        'nx-small-vulnerability-counter-container--no-max': !hasMaxDigits
      });

  function renderCounter(category: VulnerabilitySeverityLevel, count: number) {
    return hasMaxDigits ?
      <MaxDigitCounter category={category} count={count} maxDigits={maxDigits || 3} /> :
      <Counter category={category} count={count} />;
  }

  if (typeof maxDigits === 'number' && maxDigits < 1) {
    throw new Error('maxDigits must be positive');
  }

  if (typeof criticalCount !== 'number' &&
      typeof highCount !== 'number' &&
      typeof mediumCount !== 'number' &&
      typeof lowCount !== 'number' &&
      typeof noneCount !== 'number') {
    console.warn('No counts have been provided and so nothing will be rendered.');
    return null;
  }

  return (
    <div className={className} { ...attrs }>
      { typeof criticalCount === 'number' && renderCounter('critical', criticalCount) }
      { typeof highCount === 'number' && renderCounter('high', highCount) }
      { typeof mediumCount === 'number' && renderCounter('medium', mediumCount) }
      { typeof lowCount === 'number' && renderCounter('low', lowCount) }
      { typeof noneCount === 'number' && renderCounter('none', noneCount) }
    </div>
  );
}

NxSmallVulnerabilityCounter.propTypes = propTypes;
