/*
 * Copyright (c) 2019-present Sonatype, Inc.
 * This program and the accompanying materials are made available under
 * the terms of the Eclipse Public License 2.0 which accompanies this
 * distribution and is available at https://www.eclipse.org/legal/epl-2.0/.
 */
import NxVulnerabilityIndicator, { Props } from '../NxVulnerabilityIndicator';
import { rtlRender, runTimers, userEvent } from '../../../__testutils__/rtlUtils';
import { screen } from '@testing-library/react';

describe('NxVulnerabilityIndicator', function() {
  const quickRender = rtlRender<Props>(NxVulnerabilityIndicator, {});

  it('renders an element with a role of graphics-symbol', async function() {
    const el = quickRender();
    await runTimers();
    const vulnerabilityIndicator = el.getByRole('graphics-symbol');
    expect(vulnerabilityIndicator).toBeInTheDocument();
  });

  it('has a fallback role of img', async function() {
    const el = quickRender();
    await runTimers();
    const vulnerabilityIndicator = el.getByRole('img', { queryFallbacks: true });
    expect(vulnerabilityIndicator).toBeInTheDocument();
  });

  it('takes precedence of vulnerabilityLevelCategory if both props are provided', async function() {
    const el = quickRender({ policyVulnerabilityScore: '9.0', vulnerabilityLevelCategory: 'low' });
    await runTimers();
    const user = userEvent.setup(),
        vulnerabilityIndicator = el.getByRole('graphics-symbol')!;

    await user.hover(vulnerabilityIndicator);
    const tooltip = await screen.findByRole('tooltip');
    expect(tooltip).toHaveTextContent('Low');
  });

  it('sets the accessible name based on the vulnerability level category', async function() {
    const el = quickRender({ policyVulnerabilityScore: '9.0', vulnerabilityLevelCategory: 'low' });
    await runTimers();
    const vulnerabilityIndicator = el.getByRole('graphics-symbol')!;

    expect(vulnerabilityIndicator).toHaveAccessibleName('Low');
  });

  describe('should have default tooltips', function() {
    const getTooltipTextForProps = async (vulnerability: Props) => {
      const el = quickRender(vulnerability)!;
      await runTimers();
      const user = userEvent.setup(),
          vulnerabilityIndicator = el.getByRole('graphics-symbol');

      await user.hover(vulnerabilityIndicator);
      const tooltip = await screen.findByRole('tooltip');
      return tooltip.textContent;
    };

    describe('when policyVulnerabilityScore prop is provided', function() {
      it('for policyVulnerabilityScore 0', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '0.0' })).toBe('None');
      });
      it('for policyVulnerabilityScore 1', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '1.0' })).toBe('Low');
      });
      it('for policyVulnerabilityScore 2', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '2.0' })).toBe('Low');
      });
      it('for policyVulnerabilityScore 3', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '3.0' })).toBe('Low');
      });
      it('for policyVulnerabilityScore 4', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '4.0' })).toBe('Medium');
      });
      it('for policyVulnerabilityScore 5', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '5.0' })).toBe('Medium');
      });
      it('for policyVulnerabilityScore 6', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '6.0' })).toBe('Medium');
      });
      it('for policyVulnerabilityScore 7', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '7.0' })).toBe('High');
      });
      it('for policyVulnerabilityScore 8', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '8.0' })).toBe('High');
      });
      it('for policyVulnerabilityScore 9', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '9.0' })).toBe('Critical');
      });
      it('for policyVulnerabilityScore 10', async function() {
        expect(await getTooltipTextForProps({ policyVulnerabilityScore: '10.0' })).toBe('Critical');
      });
    });

    describe('when vulnerabilityLevelCategory prop is provided', function() {
      it('for vulnerabilityLevelCategory none', async function() {
        expect(await getTooltipTextForProps({ vulnerabilityLevelCategory: 'none' })).toBe('None');
      });
      it('for vulnerabilityLevelCategory low', async function() {
        expect(await getTooltipTextForProps({ vulnerabilityLevelCategory: 'low' })).toBe('Low');
      });
      it('for vulnerabilityLevelCategory medium', async function() {
        expect(await getTooltipTextForProps({ vulnerabilityLevelCategory: 'medium' })).toBe('Medium');
      });
      it('for vulnerabilityLevelCategory high', async function() {
        expect(await getTooltipTextForProps({ vulnerabilityLevelCategory: 'high' })).toBe('High');
      });
      it('for vulnerabilityLevelCategory critical', async function() {
        expect(await getTooltipTextForProps({ vulnerabilityLevelCategory: 'critical' })).toBe('Critical');
      });
    });
  });

  it('should show custom tooltip title', async function() {
    const el = quickRender({ title: 'Extinction Level Vulnerability' });
    await runTimers();
    const user = userEvent.setup(),
        vulnerabilityIndicator = el.getByRole('graphics-symbol')!;

    await user.hover(vulnerabilityIndicator);
    const tooltip = await screen.findByRole('tooltip');
    expect(tooltip).toHaveTextContent('Extinction Level Vulnerability');
  });

  describe('when presentational prop is set to true', function() {
    const quickRender = rtlRender(NxVulnerabilityIndicator, { presentational: true });

    it('should hide tooltip', async function() {
      const user = userEvent.setup(),
          vulnerabilityIndicator = quickRender().getByRole('presentation', { hidden: true });

      expect(screen.queryByRole('tooltip')).not.toBeInTheDocument();
      await user.hover(vulnerabilityIndicator);
      expect(screen.queryByRole('tooltip')).not.toBeInTheDocument();
    });

    it('should set the role to "presentation"', function() {
      const vulnerabilityIndicator = quickRender().getByRole('presentation', { hidden: true });

      expect(vulnerabilityIndicator).toBeInTheDocument();
    });

    it('should not have an accessible name', function() {
      const vulnerabilityIndicator = quickRender().getByRole('presentation', { hidden: true });

      expect(vulnerabilityIndicator).not.toHaveAccessibleName();
    });
  });
});
