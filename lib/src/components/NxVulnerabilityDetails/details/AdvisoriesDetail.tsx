/*
 * Copyright (c) 2019-present Sonatype, Inc.
 * This program and the accompanying materials are made available under
 * the terms of the Eclipse Public License 2.0 which accompanies this
 * distribution and is available at https://www.eclipse.org/legal/epl-2.0/.
 */
/* eslint react/prop-types: 0 */
import React, { FunctionComponent, ReactNode } from 'react';
import { all, filter, isEmpty, isNil, map, pipe } from 'ramda';

import { ReferenceLink, ReferenceTypeEnum } from '../types';
import DetailLink from './DetailLink';
import RenderDetail from './RenderDetail';
import SubDescriptionList from './SubDescriptionList';

export interface Props {
  advisories?: ReferenceLink[] | null;
}

function hasAllData({referenceType, url}: ReferenceLink) {
  return !!(referenceType && url);
}

function renderLinkWithLabel({referenceType, url}: ReferenceLink): ReactNode {
  return referenceType && url ? (
    <SubDescriptionList.Container key={`${referenceType}:${url}`}>
      <SubDescriptionList.Term>{ReferenceTypeEnum[referenceType]}</SubDescriptionList.Term>
      <SubDescriptionList.Desc>
        <DetailLink href={url}>{url}</DetailLink>
      </SubDescriptionList.Desc>
    </SubDescriptionList.Container>
  ) : null;
}

const renderWithTypeLabels = (links: ReferenceLink[]): ReactNode => {
  const renderedLinks =
    pipe(filter(hasAllData), map(renderLinkWithLabel))(links);
  return isEmpty(renderedLinks) ? null : (
    <SubDescriptionList>
      {renderedLinks}
    </SubDescriptionList>
  );
};

function renderPlainLink({url}: ReferenceLink): ReactNode {
  return url ? (
    <DetailLink key={url} className="nx-truncate-ellipsis" href={url}>{url}</DetailLink>
  ) : null;
}

const renderPlainLinks = pipe(filter(hasAllData), map(renderPlainLink));

const hasUnknownType = ({referenceType}: ReferenceLink): boolean => {
  const typeEnum = referenceType && ReferenceTypeEnum[referenceType];
  return isNil(typeEnum) || typeEnum === ReferenceTypeEnum.UNKNOWN;
};

const allTypesUnknown = all<ReferenceLink>(hasUnknownType);

function renderReferenceLinks(links: ReferenceLink[]): ReactNode {
  return allTypesUnknown(links) ? renderPlainLinks(links) : renderWithTypeLabels(links);
}

const AdvisoriesDetail: FunctionComponent<Props> = function AdvisoriesDetail({advisories}) {
  const referenceLinks = advisories && renderReferenceLinks(advisories);
  return isNil(referenceLinks) || isEmpty(referenceLinks) ? null : (
    <RenderDetail title="Advisories">
      {referenceLinks}
    </RenderDetail>
  );
};

export default AdvisoriesDetail;
